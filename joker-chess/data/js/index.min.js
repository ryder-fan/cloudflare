"use strict";console.warn=function(...t){Dialog.warning("警告",t.join(" "))},console.error=function(...t){Dialog.error("错误",t.join(" "))};class Dialog{static info(t,s){Swal.fire(t,s,"info")}static success(t,s){Swal.fire(t,s,"success")}static error(t,s){Swal.fire(t,s,"error")}static warning(t,s){Swal.fire(t,s,"warning")}static confirm(t,s,e){Swal.fire({title:t,text:s,icon:"question",showCancelButton:!0,confirmButtonColor:"3085d6",cancelButtonColor:"d33",confirmButtonText:"确定",cancelButtonText:"取消"}).then((t=>{t.isConfirmed?e(!0):e(!1)}))}}class GameManager{static size;static board_node;static board_img_node;static board_img_moveFrom;static board_img_moveTo;static board_img_chosen;static player_turn_node;static player_color={CC:"红方",IC:"黑方"};static player_turn;static ChessManagers={"CC-B1":void 0,"CC-B2":void 0,"CC-B3":void 0,"CC-B4":void 0,"CC-B5":void 0,"CC-C1":void 0,"CC-C2":void 0,"CC-M1":void 0,"CC-M2":void 0,"CC-P1":void 0,"CC-P2":void 0,"CC-S1":void 0,"CC-S2":void 0,"CC-W":void 0,"CC-X1":void 0,"CC-X2":void 0,"IC-B1":void 0,"IC-B2":void 0,"IC-K":void 0,"IC-N1":void 0,"IC-N2":void 0,"IC-Q":void 0,"IC-R1":void 0,"IC-R2":void 0,"IC-S1":void 0,"IC-S2":void 0,"IC-S3":void 0,"IC-S4":void 0,"IC-S5":void 0,"IC-S6":void 0,"IC-S7":void 0,"IC-S8":void 0};static moveToBoxes=[];static movingChess;static setup(){this.board_node=document.getElementById("board"),this.board_img_node=document.getElementById("board-img"),this.board_img_moveFrom=document.getElementById("move-from"),this.board_img_moveTo=document.getElementById("move-to"),this.board_img_chosen=document.getElementById("chosen"),this.player_turn_node=document.getElementById("player-turn"),document.getElementById("export-btn").addEventListener("click",this.export.bind(this)),document.getElementById("guide-btn").addEventListener("click",this.showRule.bind(this)),this.setupBoard(),this.setSize()}static setSize(){this.size=Math.min(window.innerWidth,window.innerHeight),window.innerWidth>=window.innerHeight?document.body.className="horizontal":document.body.className="vertical",this.board_node.style.width=.8*this.size+"px",this.board_node.style.height=.8*this.size+"px"}static setupBoard(){this.board_node.addEventListener("click",this.boardClicked.bind(this)),this.board_img_node.src=ImgManager.getImg("background"),this.board_img_moveFrom.src=ImgManager.getImg("chosen-y"),this.board_img_moveTo.src=ImgManager.getImg("chosen-y"),this.board_img_chosen.src=ImgManager.getImg("chosen-b");for(let t=1;t<=8;t++)for(let s=1;s<=8;s++){let e=document.createElement("img");e.src=ImgManager.getImg("chosen-r"),e.alt="move to here",e.classList.add("selectBox"),e.style.position="absolute",e.style.left=12.5*(t-1)+"%",e.style.top=12.5*(s-1)+"%",e.style.display="none",e.style.pointerEvents="none",this.board_node.appendChild(e),this.moveToBoxes.push({x:t,y:s,node:e})}let t;window.location.search.startsWith("?data=")&&(t=window.location.search.slice(6));let s=1;for(const e in Data.chessMap)this.ChessManagers[e]=new ChessManager(e),t&&(this.ChessManagers[e].setPos(Number(t[s]),Number(t[s+1])),this.ChessManagers[e].moved=Number(t[s+2]),s+=3);t&&t[0]?this.player_turn="C"==t[0]?"CC":"IC":this.player_turn="CC",this.player_turn_node.textContent=`${this.player_color[this.player_turn]}`}static choose(t,s){this.board_img_chosen.style.display="block",this.board_img_chosen.style.left=12.5*(t-1)+"%",this.board_img_chosen.style.top=12.5*(s-1)+"%"}static canMoveTipNode(t,s){for(let e of this.moveToBoxes)e.x==t&&e.y==s&&(e.node.style.display="block")}static unChooseAll(){for(let t of this.moveToBoxes)t.node.style.display="none";this.board_img_chosen.style.display="none";for(const t in this.ChessManagers)"chosen"==this.ChessManagers[t].status&&this.ChessManagers[t].unChoose();this.movingChess=void 0}static getChessByPos(t,s){for(const e in Data.chessMap){const i=this.ChessManagers[e];if(i.posx==t&&i.posy==s)return i}}static boardClicked(t){const s=Math.floor(t.offsetX/(.8*this.size/8))+1,e=Math.floor(t.offsetY/(.8*this.size/8))+1,i=this.getChessByPos(s,e);if(i)""==i.status?i.id.startsWith(this.player_turn)?(this.unChooseAll(),i.choose()):this.movingChess?this.movingChess.moveTo(s,e):Dialog.error("不是你的回合",`现在为${this.player_color[this.player_turn]}走棋`):"chosen"==i.status&&this.unChooseAll();else{if(!this.movingChess)return;this.movingChess.moveTo(s,e)}}static nextRound(t,s,e,i){"CC"==this.player_turn?this.player_turn="IC":this.player_turn="CC",this.player_turn_node.textContent=`${this.player_color[this.player_turn]}`,this.board_img_moveFrom.style.display="block",this.board_img_moveFrom.style.left=12.5*(t-1)+"%",this.board_img_moveFrom.style.top=12.5*(s-1)+"%",this.board_img_moveTo.style.display="block",this.board_img_moveTo.style.left=12.5*(e-1)+"%",this.board_img_moveTo.style.top=12.5*(i-1)+"%",this.unChooseAll()}static export(){let t="";t+="CC"==this.player_turn?"C":"I";for(const s in this.ChessManagers){const e=this.ChessManagers[s];t+="eaten"==e.status?0:e.posx,t+="eaten"==e.status?0:e.posy,t+=e.moved?1:0}const s=window.location.href.split("?")[0]+"?data="+t;navigator.clipboard?navigator.clipboard.writeText(s).then((()=>{Dialog.success("导出成功","已复制到剪贴板")})).catch((()=>{Dialog.error("导出失败",`请手动复制以下链接${s}`)})):Dialog.error("导出失败",`请手动复制以下链接${s}`)}static showRule(){window.location.href="rule.min.html"}}class ChessManager{chess_node;board_node;id;type;moved=!1;status="";posx;posy;constructor(t){this.board_node=document.getElementById("board"),this.id=t,this.type=Data.chessMap[t].type,this.createChess(t)}unChoose(){GameManager.movingChess==this&&(GameManager.movingChess=void 0),this.status=""}choose(){GameManager.movingChess=this,this.status="chosen",GameManager.choose(this.posx,this.posy);let t=MoveManager.canMovePosList(this);for(let s of t)GameManager.canMoveTipNode(s[0],s[1])}createChess(){this.chess_node=document.createElement("div"),this.chess_node.id=this.id,this.chess_node.classList.add("chess");const t=document.createElement("img");t.id=this.id+"-img",t.src=Data.chessMap[this.id].img,t.alt=this.id,this.chess_node.appendChild(t),this.board_node.appendChild(this.chess_node),this.setPos(Data.chessMap[this.id].x,Data.chessMap[this.id].y)}setPos(t,s){[1,2,3,4,5,6,7,8].includes(t)&&[1,2,3,4,5,6,7,8].includes(s)?(this.posx=t,this.posy=s,this.chess_node.style.left=12.5*(t-1)+"%",this.chess_node.style.top=12.5*(s-1)+"%"):0==t&&0==s&&(this.status="eaten",this.posx=0,this.posy=0,this.chess_node.parentNode&&this.chess_node.parentNode.removeChild(this.chess_node))}canMoveTo(t,s){if(![1,2,3,4,5,6,7,8].includes(t)||![1,2,3,4,5,6,7,8].includes(s))return!1;for(let e of MoveManager.canMovePosList(this))if(e[0]==t&&e[1]==s)return!0;return!1}moveTo(t,s){if("chosen"!=this.status)return GameManager.unChooseAll();if([1,2,3,4,5,6,7,8].includes(t)&&[1,2,3,4,5,6,7,8].includes(s)){if(!this.canMoveTo(t,s))return Dialog.warning("移动失败",`${this.id}不能从(${this.posx}, ${this.posy})移动到(${t}, ${s})`);if(GameManager.getChessByPos(t,s)){const e=GameManager.getChessByPos(t,s);e.setPos(0,0),"IC-K"==e.id&&Dialog.success("胜利","红方获胜"),"CC-W"==e.id&&Dialog.success("胜利","黑方获胜")}this.moved=!0,GameManager.nextRound(this.posx,this.posy,t,s),this.setPos(t,s)}}}class MoveManager{static isEmpty(t,s){return!GameManager.getChessByPos(t,s)}static canEat(t,s,e){if(this.isEmpty(t,s))return!0;return GameManager.getChessByPos(t,s).id.slice(0,2)!=e}static isBlock(t,s){return(1==t||8==t)&&6==s}static canMovePosList(t){const s=t.posx,e=t.posy;if(t.id.startsWith("CC")&&this.isBlock(s,e))return[];switch(t.type){case"CC-B":return this.moveCCB(s,e);case"CC-C":return this.moveCCC(s,e);case"CC-M":return this.moveCCM(s,e);case"CC-P":return this.moveCCP(s,e);case"CC-S":return this.moveCCS(s,e);case"CC-W":return this.moveCCW(s,e);case"CC-X":return this.moveCCX(s,e);case"IC-B":return this.moveICB(s,e);case"IC-K":return this.moveICK(s,e);case"IC-N":return this.moveICN(s,e);case"IC-Q":return this.moveICQ(s,e);case"IC-R":return this.moveICR(s,e);case"IC-S":return this.moveICS(s,e)}return[]}static moveCCB(t,s){let e=[];return this.canEat(t,s-1,"CC")&&e.push([t,s-1]),s<=4&&this.canEat(t-1,s,"CC")&&e.push([t-1,s]),s<=4&&this.canEat(t+1,s,"CC")&&e.push([t+1,s]),e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveCCC(t,s){let e=[];for(let i of[[-1,0],[1,0],[0,-1],[0,1]])for(let o=1;o<=8;o++){let a=t+i[0]*o,n=s+i[1]*o;if(a<1||a>8||n<1||n>8)break;if(this.isBlock(a,n)&&this.canEat(a,n,"CC")){e.push([a,n]);break}if(!this.isEmpty(a,n)){this.canEat(a,n,"CC")&&e.push([a,n]);break}e.push([a,n])}return e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveCCM(t,s){let e=[];return this.isEmpty(t,s-1)&&this.canEat(t+1,s-2,"CC")&&e.push([t+1,s-2]),this.isEmpty(t,s-1)&&this.canEat(t-1,s-2,"CC")&&e.push([t-1,s-2]),this.isEmpty(t+1,s)&&this.canEat(t+2,s-1,"CC")&&e.push([t+2,s-1]),this.isEmpty(t-1,s)&&this.canEat(t-2,s-1,"CC")&&e.push([t-2,s-1]),this.isEmpty(t,s+1)&&this.canEat(t+1,s+2,"CC")&&e.push([t+1,s+2]),this.isEmpty(t,s+1)&&this.canEat(t-1,s+2,"CC")&&e.push([t-1,s+2]),this.isEmpty(t+1,s)&&this.canEat(t+2,s+1,"CC")&&e.push([t+2,s+1]),this.isEmpty(t-1,s)&&this.canEat(t-2,s+1,"CC")&&e.push([t-2,s+1]),e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveCCP(t,s){let e=[];for(let i of[[-1,0],[1,0],[0,-1],[0,1]])for(let o=1;o<=8;o++){let a=t+i[0]*o,n=s+i[1]*o;if(a<1||a>8||n<1||n>8)break;if(this.isBlock(a,n)&&this.isEmpty(a,n)){e.push([a,n]);break}if(!this.isEmpty(a,n))break;e.push([a,n])}for(let i=1;i<=8;i++)for(let o=1;o<=8;o++){if(this.isEmpty(i,o))continue;if(!this.canEat(i,o,"CC"))continue;let a=GameManager.getChessByPos(i,o),n=Math.min(t,i),r=Math.max(t,i),h=Math.min(s,o),c=Math.max(s,o),C=0;if(i==t){for(let s=h+1;s<c;s++)1!=t&&8!=t||6!=s||(C=1/0),this.isEmpty(i,s)||C++;1==C&&e.push([i,o])}if(o==s){for(let t=n+1;t<r;t++)this.isEmpty(t,o)||C++;1==C&&e.push([i,o])}if(i!=t&&o!=s){if(!a.moved)continue;let h=(o-s)/(i-t),c=s-h*t;for(let t=n+1;t<r;t++){if(!Number.isInteger(h*t+c))continue;let s=h*t+c;this.isEmpty(t,s)||C++}1==C&&e.push([i,o])}}return e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveCCS(t,s){let e=[];for(let i of[[-1,-1],[-1,1],[1,-1],[1,1]])this.canEat(t+i[0],s+i[1],"CC")&&e.push([t+i[0],s+i[1]]);return e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveCCW(t,s){let e=[];for(let i of[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]])this.canEat(t+i[0],s+i[1],"CC")&&e.push([t+i[0],s+i[1]]);return e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveCCX(t,s){let e=[];for(let i of[[-1,-1],[-1,1],[1,-1],[1,1]])for(let o=1;o<=3;o++)1!=o?this.isEmpty(t+i[0]*(o-1),s+i[1]*(o-1))&&this.canEat(t+i[0]*o,s+i[1]*o,"CC")&&e.push([t+i[0]*o,s+i[1]*o]):this.canEat(t+i[0],s+i[1],"CC")&&e.push([t+i[0],s+i[1]]);return e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveICB(t,s){let e=[];for(let i of[[-1,-1],[-1,1],[1,-1],[1,1]])for(let o=1;o<=8;o++){let a=t+i[0]*o,n=s+i[1]*o;if(a<1||a>8||n<1||n>8)break;if(this.isBlock(a,n)&&this.canEat(a,n,"IC")){e.push([a,n]);break}if(!this.isEmpty(a,n)){this.canEat(a,n,"IC")&&e.push([a,n]);break}e.push([a,n])}return e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveICK(t,s){let e=[];for(let i of[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]])this.canEat(t+i[0],s+i[1],"IC")&&e.push([t+i[0],s+i[1]]);return e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveICN(t,s){let e=[];for(let i of[[-1,-2],[-2,-1],[-2,1],[-1,2],[1,-2],[2,-1],[2,1],[1,2]])this.canEat(t+i[0],s+i[1],"IC")&&e.push([t+i[0],s+i[1]]);return e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveICQ(t,s){let e=[];for(let i of[[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,-1],[1,-1],[-1,1]])for(let o=1;o<=8;o++){let a=t+i[0]*o,n=s+i[1]*o;if(a<1||a>8||n<1||n>8)break;if(this.isBlock(a,n)){this.canEat(a,n,"IC")&&e.push([a,n]);break}if(!this.isEmpty(a,n)){this.canEat(a,n,"IC")&&e.push([a,n]);break}e.push([a,n])}return e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveICR(t,s){let e=[];for(let i of[[-1,0],[1,0],[0,-1],[0,1]])for(let o=1;o<=8;o++){let a=t+i[0]*o,n=s+i[1]*o;if(a<1||a>8||n<1||n>8)break;if(this.isBlock(a,n)){this.canEat(a,n,"IC")&&e.push([a,n]);break}if(!this.isEmpty(a,n)){this.canEat(a,n,"IC")&&e.push([a,n]);break}e.push([a,n])}return e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}static moveICS(t,s){let e=[];return this.isEmpty(t,s+1)&&e.push([t,s+1]),!this.isEmpty(t-1,s+1)&&this.canEat(t-1,s+1,"IC")&&e.push([t-1,s+1]),!this.isEmpty(t+1,s+1)&&this.canEat(t+1,s+1,"IC")&&e.push([t+1,s+1]),2==s&&this.isEmpty(t,s+1)&&this.isEmpty(t,s+2)&&e.push([t,s+2]),e.filter((t=>t[0]>=1&&t[0]<=8&&t[1]>=1&&t[1]<=8))}}document.addEventListener("DOMContentLoaded",(()=>ImgManager.loadImgs(GameManager.setup.bind(GameManager)))),window.addEventListener("resize",GameManager.setSize.bind(GameManager));