document.addEventListener("DOMContentLoaded",(async()=>{let e,t,s=0,n=new Map,l=document.getElementById("tile-container"),i=!1,o=!1,a=0,d=c("best")||0;function r(e,t){localStorage.setItem(e,t)}function c(e){return localStorage.getItem(e)}function u(e){localStorage.removeItem(e)}function $(){let e=Math.min(window.innerWidth,window.innerHeight-200)-20;document.documentElement.style.setProperty("--size",e/4.5+"px")}function m(){a>d&&(d=a,r("best",d)),document.getElementById("score-value").textContent=a,document.getElementById("best-value").textContent=d}function f(e,t,i){if(![1,2,3,4].includes(e)||![1,2,3,4].includes(t))return;if(![2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536].includes(i))return;if(n.has(`${e}-${t}`))return;s++,n.set(`${e}-${t}`,{value:i,index:s});let o=document.createElement("div");o.id=`tile-${s}`,o.classList.add("tile"),o.classList.add(`tile-${i}`),o.classList.add(`pos-${e}-${t}`),o.classList.add("hidden");let a=document.createElement("p");a.textContent=i,o.appendChild(a),l.appendChild(o),setTimeout((()=>{o.classList.remove("hidden")}),10)}function h(){let e=[];for(let t=1;t<=4;t++)for(let s=1;s<=4;s++){let l=`${t}-${s}`;n.has(l)||e.push({x:t,y:s})}if(0==e.length)i=!0,Swal.fire({title:"Game over!",icon:"error",confirmButtonText:"Try again"}).then((e=>{e.isConfirmed&&window.location.reload()}));else{let t=Math.random()<.9?2:4,s=Math.floor(Math.random()*e.length),{x:n,y:l}=e[s];f(n,l,t)}}function v(){let e="";for(let t=1;t<=4;t++)for(let s=1;s<=4;s++){let l=`${t}-${s}`;if(n.has(l)){let{index:i,value:o}=n.get(l);e+=`${t}-${s}-${i}-${o},`}}return e}function p(e){if(i||o)return;o=!0;let t=v();switch(e){case"left":!function(){for(let e=1;e<=4;e++){let t,s=0,l=0;for(let i=1;i<=4;i++){let o=`${i}-${e}`;if(!n.has(o))continue;let{value:d,index:r}=n.get(o),c=document.getElementById(`tile-${r}`);if(d==s){let u=l,$=t;s=0,c.classList.remove(`pos-${i}-${e}`),c.classList.add(`pos-${u}-${e}`),n.delete(o),setTimeout((()=>{$.parentNode.removeChild($),n.set(`${u}-${e}`,{value:2*d,index:r}),c.classList.remove(`tile-${d}`),c.classList.add("tile-"+2*d),c.children[0].textContent=2*d,a+=d,m()}),220)}else{let a=l+1;t=c,s=d,l++,c.classList.remove(`pos-${i}-${e}`),c.classList.add(`pos-${a}-${e}`),n.delete(o),n.set(`${a}-${e}`,{value:d,index:r})}}}}();break;case"right":!function(){for(let e=1;e<=4;e++){let t,s=0,l=0;for(let i=4;i>=1;i--){let o=`${i}-${e}`;if(!n.has(o))continue;let{value:d,index:r}=n.get(o),c=document.getElementById(`tile-${r}`);if(d==s){let u=5-l,$=t;s=0,c.classList.remove(`pos-${i}-${e}`),c.classList.add(`pos-${u}-${e}`),n.delete(o),setTimeout((()=>{$.parentNode.removeChild($),n.set(`${u}-${e}`,{value:2*d,index:r}),c.classList.remove(`tile-${d}`),c.classList.add("tile-"+2*d),c.children[0].textContent=2*d,a+=d,m()}),220)}else{let a=4-l;t=c,s=d,l++,c.classList.remove(`pos-${i}-${e}`),c.classList.add(`pos-${a}-${e}`),n.delete(o),n.set(`${a}-${e}`,{value:d,index:r})}}}}();break;case"up":!function(){for(let e=1;e<=4;e++){let t,s=0,l=0;for(let i=1;i<=4;i++){let o=`${e}-${i}`;if(!n.has(o))continue;let{value:d,index:r}=n.get(o),c=document.getElementById(`tile-${r}`);if(d==s){let u=l,$=t;s=0,c.classList.remove(`pos-${e}-${i}`),c.classList.add(`pos-${e}-${u}`),n.delete(o),setTimeout((()=>{$.parentNode.removeChild($),n.set(`${e}-${u}`,{value:2*d,index:r}),c.classList.remove(`tile-${d}`),c.classList.add("tile-"+2*d),c.children[0].textContent=2*d,a+=d,m()}),220)}else{let a=l+1;t=c,s=d,l++,c.classList.remove(`pos-${e}-${i}`),c.classList.add(`pos-${e}-${a}`),n.delete(o),n.set(`${e}-${a}`,{value:d,index:r})}}}}();break;case"down":!function(){for(let e=1;e<=4;e++){let t,s=0,l=0;for(let i=4;i>=1;i--){let o=`${e}-${i}`;if(!n.has(o))continue;let{value:d,index:r}=n.get(o),c=document.getElementById(`tile-${r}`);if(d==s){let u=5-l,$=t;s=0,c.classList.remove(`pos-${e}-${i}`),c.classList.add(`pos-${e}-${u}`),n.delete(o),setTimeout((()=>{$.parentNode.removeChild($),n.set(`${e}-${u}`,{value:2*d,index:r}),c.classList.remove(`tile-${d}`),c.classList.add("tile-"+2*d),c.children[0].textContent=2*d,a+=d,m()}),220)}else{let a=4-l;t=c,s=d,l++,c.classList.remove(`pos-${e}-${i}`),c.classList.add(`pos-${e}-${a}`),n.delete(o),n.set(`${e}-${a}`,{value:d,index:r})}}}}();break}setTimeout((()=>{o=!1,v()!=t&&(h(),r("current",v()),r("score",a))}),250)}if($(),window.addEventListener("resize",$),c("current")){a=Number(c("score"))||0;let e=c("current").split(",");for(let t=0;t<e.length;t++){let[s,n,,l]=e[t].split("-").map(Number);f(s,n,l)}}else h(),h();m(),window.addEventListener("keydown",(e=>{if(!i)switch(e.key){case"ArrowLeft":p("left");break;case"ArrowRight":p("right");break;case"ArrowUp":p("up");break;case"ArrowDown":p("down");break}})),window.addEventListener("touchstart",(t=>{i||(e=t.touches[0])})),window.addEventListener("touchend",(t=>{if(i)return;let s=t.changedTouches[0].clientX-e.clientX,n=t.changedTouches[0].clientY-e.clientY;Math.abs(s)<50&&Math.abs(n)<50||(Math.abs(s)>Math.abs(n)?p(s<0?"left":"right"):p(n<0?"up":"down"))})),window.addEventListener("mousedown",(e=>{i||(t=e)})),window.addEventListener("mouseup",(e=>{if(i)return;let s=e.clientX-t.clientX,n=e.clientY-t.clientY;Math.abs(s)<50&&Math.abs(n)<50||(Math.abs(s)>Math.abs(n)?p(s<0?"left":"right"):p(n<0?"up":"down"))})),document.getElementById("new-game").addEventListener("click",(()=>{u("current"),u("score"),window.location.reload()}))}));