document.addEventListener("DOMContentLoaded",(async()=>{let e,t=0,s=new Map,l=document.getElementById("tile-container"),n=!1,i=!1,o=0;function a(e,t){localStorage.setItem(e,t)}function d(e){return localStorage.getItem(e)}function r(e){localStorage.removeItem(e)}function c(){let e=Math.min(window.innerWidth,window.innerHeight-150)-20;document.documentElement.style.setProperty("--size",e/4.5+"px")}function $(){document.getElementById("score-value").textContent=o}function u(e,n,i){if(![1,2,3,4].includes(e)||![1,2,3,4].includes(n))return;if(![2,4,8,16,32,64,128,256,512,1024,2048].includes(i))return;if(s.has(`${e}-${n}`))return;t++,s.set(`${e}-${n}`,{value:i,index:t});let o=document.createElement("div");o.id=`tile-${t}`,o.classList.add("tile"),o.classList.add(`tile-${i}`),o.classList.add(`pos-${e}-${n}`),o.classList.add("hidden");let a=document.createElement("p");a.textContent=i,o.appendChild(a),l.appendChild(o),setTimeout((()=>{o.classList.remove("hidden")}),10)}function m(){let e=[];for(let t=1;t<=4;t++)for(let l=1;l<=4;l++){let n=`${t}-${l}`;s.has(n)||e.push({x:t,y:l})}if(0==e.length)n=!0,Swal.fire({title:"Game over!",icon:"error",confirmButtonText:"Try again"}).then((e=>{e.isConfirmed&&window.location.reload()}));else{let t=Math.random()<.9?2:4,s=Math.floor(Math.random()*e.length),{x:l,y:n}=e[s];u(l,n,t)}}function f(){let e="";for(let t=1;t<=4;t++)for(let l=1;l<=4;l++){let n=`${t}-${l}`;if(s.has(n)){let{index:i,value:o}=s.get(n);e+=`${t}-${l}-${i}-${o},`}}return e}function h(e){if(n||i)return;i=!0;let t=f();switch(e){case"left":!function(){for(let e=1;e<=4;e++){let t,l=0,n=0;for(let i=1;i<=4;i++){let a=`${i}-${e}`;if(!s.has(a))continue;let{value:d,index:r}=s.get(a),c=document.getElementById(`tile-${r}`);if(d==l){let u=n,m=t;l=0,c.classList.remove(`pos-${i}-${e}`),c.classList.add(`pos-${u}-${e}`),s.delete(a),setTimeout((()=>{m.parentNode.removeChild(m),s.set(`${u}-${e}`,{value:2*d,index:r}),c.classList.remove(`tile-${d}`),c.classList.add("tile-"+2*d),c.children[0].textContent=2*d,o+=d,$()}),220)}else{let o=n+1;t=c,l=d,n++,c.classList.remove(`pos-${i}-${e}`),c.classList.add(`pos-${o}-${e}`),s.delete(a),s.set(`${o}-${e}`,{value:d,index:r})}}}}();break;case"right":!function(){for(let e=1;e<=4;e++){let t,l=0,n=0;for(let i=4;i>=1;i--){let a=`${i}-${e}`;if(!s.has(a))continue;let{value:d,index:r}=s.get(a),c=document.getElementById(`tile-${r}`);if(d==l){let u=5-n,m=t;l=0,c.classList.remove(`pos-${i}-${e}`),c.classList.add(`pos-${u}-${e}`),s.delete(a),setTimeout((()=>{m.parentNode.removeChild(m),s.set(`${u}-${e}`,{value:2*d,index:r}),c.classList.remove(`tile-${d}`),c.classList.add("tile-"+2*d),c.children[0].textContent=2*d,o+=d,$()}),220)}else{let o=4-n;t=c,l=d,n++,c.classList.remove(`pos-${i}-${e}`),c.classList.add(`pos-${o}-${e}`),s.delete(a),s.set(`${o}-${e}`,{value:d,index:r})}}}}();break;case"up":!function(){for(let e=1;e<=4;e++){let t,l=0,n=0;for(let i=1;i<=4;i++){let a=`${e}-${i}`;if(!s.has(a))continue;let{value:d,index:r}=s.get(a),c=document.getElementById(`tile-${r}`);if(d==l){let u=n,m=t;l=0,c.classList.remove(`pos-${e}-${i}`),c.classList.add(`pos-${e}-${u}`),s.delete(a),setTimeout((()=>{m.parentNode.removeChild(m),s.set(`${e}-${u}`,{value:2*d,index:r}),c.classList.remove(`tile-${d}`),c.classList.add("tile-"+2*d),c.children[0].textContent=2*d,o+=d,$()}),220)}else{let o=n+1;t=c,l=d,n++,c.classList.remove(`pos-${e}-${i}`),c.classList.add(`pos-${e}-${o}`),s.delete(a),s.set(`${e}-${o}`,{value:d,index:r})}}}}();break;case"down":!function(){for(let e=1;e<=4;e++){let t,l=0,n=0;for(let i=4;i>=1;i--){let a=`${e}-${i}`;if(!s.has(a))continue;let{value:d,index:r}=s.get(a),c=document.getElementById(`tile-${r}`);if(d==l){let u=5-n,m=t;l=0,c.classList.remove(`pos-${e}-${i}`),c.classList.add(`pos-${e}-${u}`),s.delete(a),setTimeout((()=>{m.parentNode.removeChild(m),s.set(`${e}-${u}`,{value:2*d,index:r}),c.classList.remove(`tile-${d}`),c.classList.add("tile-"+2*d),c.children[0].textContent=2*d,o+=d,$()}),220)}else{let o=4-n;t=c,l=d,n++,c.classList.remove(`pos-${e}-${i}`),c.classList.add(`pos-${e}-${o}`),s.delete(a),s.set(`${e}-${o}`,{value:d,index:r})}}}}();break}setTimeout((()=>{i=!1,f()!=t&&(m(),a("current",f()),a("score",o))}),250)}if(c(),window.addEventListener("resize",c),d("current")){o=Number(d("score")),$();let e=d("current").split(",");for(let t=0;t<e.length;t++){let[s,l,,n]=e[t].split("-").map(Number);u(s,l,n)}}else m(),m();window.addEventListener("keydown",(e=>{if(!n)switch(e.key){case"ArrowLeft":h("left");break;case"ArrowRight":h("right");break;case"ArrowUp":h("up");break;case"ArrowDown":h("down");break}})),window.addEventListener("touchstart",(t=>{n||(e=t.touches[0])})),window.addEventListener("touchend",(t=>{if(n)return;let s=t.changedTouches[0].clientX-e.clientX,l=t.changedTouches[0].clientY-e.clientY;Math.abs(s)<50&&Math.abs(l)<50||(Math.abs(s)>Math.abs(l)?h(s<0?"left":"right"):h(l<0?"up":"down"))})),document.getElementById("new-game").addEventListener("click",(()=>{r("current"),r("score"),window.location.reload()}))}));